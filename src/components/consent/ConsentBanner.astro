---
// src/components/consent/ConsentBannerKlinova.astro

import logoKlinova from '~/assets/images/logo_klinova.webp';

const STORAGE_KEY = 'consent.analytics';
---

<style>
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideUp {
    from {
      transform: translateY(12px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .consent-overlay-show {
    animation: fadeIn 0.25s ease-out;
  }

  .consent-modal-show {
    animation: slideUp 0.28s cubic-bezier(0.33, 1, 0.68, 1);
  }
</style>

<div
  id="consent-overlay"
  class="fixed inset-0 z-50 hidden bg-black/40 backdrop-blur-sm consent-overlay-show
         flex items-center justify-center p-4 md:p-6"
>
  <div
    class="consent-modal-show bg-white w-full max-w-lg md:max-w-xl mx-auto
           rounded-2xl shadow-2xl px-6 py-6 md:px-10 md:py-8"
    role="dialog"
    aria-modal="true"
    aria-labelledby="consent-title"
  >
    <!-- Logo + titre -->
    <div class="flex items-center gap-3 mb-4">
      <img
        src={logoKlinova.src}
        alt="Klinova"
        class="h-9 w-auto object-contain"
        loading="lazy"
      />
      <div>
        <h2
          id="consent-title"
          class="text-xl font-semibold text-[#1E2939]"
        >
          Bienvenue chez Klinova
        </h2>
        <p class="text-sm text-[#64748B]">
          Votre confiance est notre priorité.
        </p>
      </div>
    </div>

    <!-- Texte principal -->
    <div class="space-y-3 mb-6">
      <p class="text-base text-[#475569] leading-relaxed">
        Nous respectons votre vie privée&nbsp;: nous utilisons uniquement des cookies
        de mesure d’audience pour améliorer notre site.
        Aucune donnée n’est revendue ni partagée avec des tiers publicitaires.
      </p>

      <ul class="space-y-1.5 text-sm text-[#1E2939]">
        <li class="flex items-start gap-2">
          <span class="mt-1 inline-block h-3 w-3 rounded-full bg-[#3F8D65]"></span>
          <span>Données utilisées uniquement pour analyser l’usage du site.</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="mt-1 inline-block h-3 w-3 rounded-full bg-[#3F8D65]"></span>
          <span>Pas de reciblage publicitaire, pas de vente de vos informations.</span>
        </li>
      </ul>
    </div>

    <!-- Actions -->
    <div class="space-y-2">
      <button
        id="consent-accept"
        type="button"
        class="w-full inline-flex items-center justify-center
               rounded-xl bg-[#3F8D65] px-4 py-3
               text-base font-semibold text-white
               hover:bg-[#387B58] transition-colors"
      >
        Accepter et continuer
      </button>

      <button
        id="consent-decline"
        type="button"
        class="w-full text-sm text-[#475569] text-center
               underline underline-offset-2 hover:text-[#1E2939]"
      >
        Continuer sans accepter
      </button>
    </div>
  </div>
</div>

<script is:inline>
  (function () {
    var KEY = 'consent.analytics';
    var overlay = document.getElementById('consent-overlay');

    var stored = null;
    try {
      stored = localStorage.getItem(KEY);
    } catch (e) {}

    function show() {
      if (!overlay) return;
      overlay.classList.remove('hidden');
      // classes flex / center déjà dans le HTML
      document.body.dataset.consentScrollLock = '1';
      document.body.style.overflow = 'hidden';
    }

    function hide() {
      if (!overlay) return;
      overlay.classList.add('hidden');
      if (document.body.dataset.consentScrollLock) {
        delete document.body.dataset.consentScrollLock;
        document.body.style.overflow = '';
      }
    }

    function accept() {
      try {
        localStorage.setItem(KEY, 'granted');
      } catch (e) {}
      hide();
      window.dispatchEvent(new CustomEvent('consent:granted'));
    }

    function decline() {
      try {
        localStorage.setItem(KEY, 'denied');
      } catch (e) {}
      hide();
      window.dispatchEvent(new CustomEvent('consent:denied'));
    }

    if (stored !== 'granted' && stored !== 'denied') {
      show();
    }

    var acceptBtn = document.getElementById('consent-accept');
    var declineBtn = document.getElementById('consent-decline');

    if (acceptBtn) acceptBtn.addEventListener('click', accept);
    if (declineBtn) declineBtn.addEventListener('click', decline);

    // Pas de fermeture sur clic overlay : on force un choix explicite.
  })();
</script>
