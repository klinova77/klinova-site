---
import { PHONE_E164, PHONE_DISPLAY } from '~/lib/phone';

export interface PopupFormProps {
  context?: {
    title?: string;
    subtitle?: string;
    serviceKey?: string;
    serviceLabel?: string;
    trackingSource?: string;
    presetSubject?: string;
    creditImpotEnabled?: boolean;
    showFileUpload?: boolean;
    maxFiles?: number;
  };
}

const {
  context = {
    title: 'Devis express anti-punaises',
    subtitle: 'Réponse sous 4h • Intervention possible aujourd\'hui',
    serviceKey: 'general',
    serviceLabel: 'Demande générale',
    trackingSource: 'popup-general',
    presetSubject: 'Demande de devis',
    creditImpotEnabled: false,
    showFileUpload: true,
    maxFiles: 5
  }
} = Astro.props as PopupFormProps;
---

<!-- POPUP OVERLAY -->
<div class="popup-overlay" id="popupOverlay" hidden>
  <div
    class="popup-form"
    id="popupForm"
    role="dialog"
    aria-modal="true"
    aria-labelledby="popupTitleH2"
    tabindex="-1"
  >
    <!-- Header -->
    <div class="popup-header relative overflow-hidden">
      <div class="absolute inset-0 opacity-10 pointer-events-none" aria-hidden="true">
        <svg class="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
          <defs>
            <pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse">
              <path d="M 10 0 L 0 0 0 10" fill="none" stroke="white" stroke-width="0.5" />
            </pattern>
          </defs>
          <rect width="100" height="100" fill="url(#grid)" />
        </svg>
      </div>

      <div class="relative z-10">
        <div class="header-accent"></div>

        <div id="popupTitle">
          <h2 id="popupTitleH2" class="popup-title">{context.title}</h2>
          <p class="popup-subtitle">{context.subtitle}</p>

          <div class="trust-badges">
            <div class="trust-item">
              <div class="trust-icon-wrapper">
                <svg class="trust-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <span>Professionnel certifié</span>
            </div>
            <div class="trust-item">
              <div class="trust-icon-wrapper">
                <svg class="trust-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <span>Réponse &lt; 4h ouvrées</span>
            </div>
            <div class="trust-item">
              <div class="trust-icon-wrapper">
                <svg class="trust-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path
                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                  />
                </svg>
              </div>
              <span>Données protégées RGPD</span>
            </div>
          </div>
        </div>
      </div>

      <button class="popup-close" id="closePopup" aria-label="Fermer">
        <span class="close-icon"></span>
      </button>
    </div>

    <!-- Body -->
    <div class="popup-body">
      <!-- Form -->
      <form id="contactForm" action="/api/contact" method="POST" novalidate>
        <input type="text" name="website" style="display:none;" tabindex="-1" autocomplete="off">
        <input type="hidden" id="popup-service-key" name="service_key" value={context.serviceKey}>
        <input type="hidden" id="popup-service-label" name="service_label" value={context.serviceLabel}>
        <input type="hidden" id="popup-subject" name="subject" value={context.presetSubject}>
        <input type="hidden" name="page_path" value={Astro.url.pathname}>
        <input type="hidden" name="source" value={context.trackingSource}>

        <!-- Prénom -->
        <div class="form-group premium">
          <div class="floating-label-group">
            <input
              type="text"
              id="popup-prenom"
              name="prenom"
              class="form-input premium"
              placeholder=" "
              required
              autocomplete="given-name"
            >
            <label class="floating-label required" for="popup-prenom">Prénom</label>
            <div class="field-border"></div>
          </div>
        </div>

        <!-- Téléphone -->
        <div class="form-group premium">
          <div class="floating-label-group">
            <input
              type="tel"
              id="popup-telephone"
              name="telephone"
              class="form-input premium"
              placeholder=" "
              autocomplete="tel"
              inputmode="tel"
              required
            >
            <label class="floating-label required" for="popup-telephone">Téléphone</label>
            <div class="field-border"></div>
            <div class="input-hint">Format : 06... ou +33...</div>
          </div>
        </div>

        <!-- Code postal -->
        <div class="form-group premium">
          <div class="floating-label-group">
            <input
              type="text"
              id="popup-code-postal"
              name="code_postal"
              class="form-input premium"
              placeholder=" "
              inputmode="numeric"
              pattern="[0-9]{5}"
              required
              maxlength="5"
            >
            <label class="floating-label required" for="popup-code-postal">Code postal</label>
            <div class="field-border"></div>
            <div class="input-hint">5 chiffres (ex. 75011). Île-de-France uniquement.</div>
          </div>
        </div>

        <!-- Crédit d'impôt (conditionnel) -->
        {context.creditImpotEnabled && (
          <div class="form-group premium" id="credit-impot-question">
            <label class="switch-label">
              Particuliers: souhaitez-vous bénéficier du crédit d'impôt et ne payer que 50 % du prix ?
            </label>
            <div class="credit-impot-radios" role="radiogroup" aria-label="Crédit d'impôt">
              <label class="radio-pill" for="credit-impot-oui">
                <input type="radio" id="credit-impot-oui" name="credit_impot" value="oui">
                <span>Oui</span>
              </label>
              <label class="radio-pill" for="credit-impot-non">
                <input type="radio" id="credit-impot-non" name="credit_impot" value="non" checked>
                <span>Non</span>
              </label>
            </div>
          </div>
        )}

        <!-- Photos (conditionnel) -->
        {context.showFileUpload && (
          <div class="form-group premium">
            <label class="switch-label">Photos (optionnel)</label>
            <div class="popup-photos-drop border-2 border-dashed" id="popup-photos-drop"
                 data-max={context.maxFiles}
                 data-max-mb="8">
              <input type="file" id="popup-photos" name="__photos_local" accept="image/*" multiple class="hidden" />
              <label for="popup-photos" class="popup-photos-label">
                <svg class="popup-photos-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14
                           m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <div>
                  <div class="photos-title">Cliquez pour ajouter des photos</div>
                  <div class="photos-help">Max {context.maxFiles} photos • 8 MB / photo • JPG/PNG/WEBP</div>
                </div>
              </label>
            </div>
            <div id="popup-photos-status" class="popup-photos-status">Aucune photo</div>
            <ul id="popup-photos-list" class="popup-photos-list hidden"></ul>
            <div id="popup-photos-hidden" class="hidden"></div>
          </div>
        )}

        <!-- RGPD -->
        <div class="checkbox-group premium">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="popup-rgpd" name="rgpd" class="checkbox-input" required>
            <label for="popup-rgpd" class="checkbox-label">
              <div class="checkbox-box">
                <svg class="checkbox-check" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M9 12l2 2 4-4"/>
                </svg>
              </div>
              <span class="checkbox-text">
                J'accepte que mes données soient utilisées pour me recontacter dans le cadre de ma demande.
                <a href="/politique-de-confidentialite" target="_blank" rel="noopener" class="link-primary">En savoir plus</a>
              </span>
            </label>
          </div>
        </div>

        <!-- Message de succès/erreur repositionné -->
        <div id="formMessage" class="form-message premium" style="display:none;" role="status" aria-live="polite"></div>

        <!-- Actions -->
        <div class="form-actions premium">
          <button type="submit" class="btn-primary premium" id="submitBtn">
            <span class="btn-content">
              <span class="loading-spinner"></span>
              <span id="submitText">Envoyer ma demande</span>
            </span>
          </button>

          <a href={`tel:${PHONE_E164}`} class="btn-call premium">
            <div class="call-content">
              <div class="call-icon-wrapper">
                <svg class="call-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                </svg>
              </div>
              <div class="call-text">
                <span class="call-label">Ou appelez maintenant</span>
                <span class="call-number">{PHONE_DISPLAY}</span>
              </div>
            </div>
          </a>
        </div>

        <!-- Footer reassurance -->
        <div class="footer-reassurance premium">
          <div class="reassurance-items">
            <div class="reassurance-item">
              <svg class="reassurance-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>Sans engagement</span>
            </div>
            <div class="reassurance-item">
              <svg class="reassurance-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              <span>Prix transparents</span>
            </div>
            <div class="reassurance-item">
              <svg class="reassurance-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
              </svg>
              <span>Intervention discrète</span>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.popup-form {
  --premium-border-radius: 16px;
  --premium-shadow: 0 20px 60px rgba(26, 62, 114, 0.15);
  /* ✅ COULEUR PRINCIPALE: Bleu foncé harmonisé avec le header */
  --popup-primary: #1a3e72;
  --popup-primary-light: #243b53;
  --premium-gradient: linear-gradient(135deg, var(--popup-primary) 0%, var(--popup-primary-light) 100%);
  --premium-transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  --glass-bg: rgba(255, 255, 255, 0.95);
  --glass-backdrop: blur(20px);
}

.popup-overlay[hidden] { display: none !important; }

.popup-overlay {
  position: fixed;
  inset: 0;
  background: rgba(26, 62, 114, 0.4);
  backdrop-filter: var(--glass-backdrop);
  z-index: 9998;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.35s ease, visibility 0s linear 0.35s;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.popup-overlay.active {
  opacity: 1;
  visibility: visible;
  transition: opacity 0.4s ease;
}

.popup-form {
  background: var(--glass-bg);
  backdrop-filter: var(--glass-backdrop);
  border-radius: 24px;
  box-shadow: var(--premium-shadow);
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  transform: scale(0.95);
  opacity: 0;
  transition: transform 0.4s ease, opacity 0.4s ease;
}

.popup-overlay.active .popup-form { 
  transform: scale(1); 
  opacity: 1; 
}

.popup-header {
  background: linear-gradient(135deg, var(--popup-primary) 0%, var(--popup-primary-light) 100%);
  color: white;
  padding: 22px 26px 18px;
  border-radius: 24px 24px 0 0;
  position: relative;
  overflow: hidden;
}

.popup-header::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.12), transparent 70%);
  z-index: 0;
}

.popup-header .relative {
  position: relative;
  z-index: 2;
}

.header-accent {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, #fff 0%, rgba(255,255,255,0.8) 50%, #fff 100%);
  animation: shimmer 2s ease-in-out infinite;
  z-index: 1;
}

@keyframes shimmer { 
  0%, 100% { opacity: 0.6; } 
  50% { opacity: 1; } 
}

/* ✅ TITRES EN BLANC ET HARMONISÉS */
.popup-title {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 6px;
  letter-spacing: -0.02em;
  line-height: 1.2;
  color: white !important; /* Force le blanc */
}

.popup-subtitle {
  color: rgba(255,255,255,0.95) !important; /* Force le blanc transparent */
  font-size: 15px;
  margin-bottom: 12px;
  font-weight: 500;
}

.trust-badges {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 8px;
  font-size: 13px;
  margin-top: 12px;
}

.trust-item {
  display: flex;
  align-items: center;
  gap: 8px;
  color: rgba(255,255,255,0.95);
  font-weight: 500;
}

.trust-icon-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  background: rgba(255,255,255,0.2);
  border-radius: 50%;
  flex: 0 0 20px;
}

.trust-icon { 
  width: 12px; 
  height: 12px; 
  stroke-width: 2.5; 
}

.popup-close {
  position: absolute;
  top: 24px;
  right: 24px;
  width: 40px;
  height: 40px;
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: white;
  z-index: 10;
  transition: var(--premium-transition);
}

.popup-close:hover {
  background: rgba(255,255,255,0.25);
  transform: rotate(90deg) scale(1.1);
}

.close-icon {
  width: 16px;
  height: 16px;
  position: relative;
}

.close-icon::before,
.close-icon::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 16px;
  height: 2px;
  background: currentColor;
  border-radius: 1px;
}

.close-icon::before { 
  transform: translate(-50%, -50%) rotate(45deg); 
}

.close-icon::after { 
  transform: translate(-50%, -50%) rotate(-45deg); 
}

.popup-body {
  padding: 26px 26px 30px;
}

.form-group.premium { 
  margin-bottom: 16px; 
}

.floating-label-group { 
  position: relative; 
}

.form-input.premium {
  width: 100%;
  min-height: 50px;
  padding: 15px 14px 7px;
  border: 2px solid #e5e7eb;
  border-radius: var(--premium-border-radius);
  font-size: 15px;
  background: white;
  transition: var(--premium-transition);
  color: #475569;
  box-shadow: 0 2px 8px rgba(26, 62, 114, 0.06);
}

.form-input.premium:focus {
  outline: none;
  /* ✅ FOCUS avec la couleur popup principale */
  border-color: var(--popup-primary);
  box-shadow: 0 0 0 4px rgba(26, 62, 114, 0.15);
}

.floating-label {
  position: absolute;
  left: 14px;
  top: 14px;
  font-size: 14px;
  color: #6b7280;
  transition: var(--premium-transition);
  pointer-events: none;
  font-weight: 500;
}

.floating-label.required::after { 
  content: ' *'; 
  color: #ef4444; 
}

.form-input.premium:focus + .floating-label,
.form-input.premium:not(:placeholder-shown) + .floating-label {
  transform: translateY(-20px) scale(0.9);
  /* ✅ LABEL actif avec la couleur popup principale */
  color: var(--popup-primary);
  font-weight: 600;
}

.field-border {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--premium-gradient);
  transform: scaleX(0);
  transition: var(--premium-transition);
}

.form-input.premium:focus ~ .field-border { 
  transform: scaleX(1); 
}

.input-hint {
  position: absolute;
  right: 14px;
  bottom: 8px;
  font-size: 11px;
  color: #6b7280;
  opacity: 0;
  transition: var(--premium-transition);
  pointer-events: none;
}

.form-input.premium:focus ~ .input-hint { 
  opacity: 1; 
}

.switch-label {
  display: block;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 8px;
  font-size: 15px;
}

.credit-impot-radios {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.radio-pill {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  border: 2px solid #e5e7eb;
  border-radius: 999px;
  cursor: pointer;
  background: #fff;
  transition: var(--premium-transition);
}

.radio-pill input[type="radio"] {
  width: 16px;
  height: 16px;
  /* ✅ ACCENT COLOR avec la couleur popup principale */
  accent-color: var(--popup-primary);
}

.radio-pill:hover {
  border-color: var(--popup-primary);
  background: #f1f5f9;
}

.radio-pill input[type="radio"]:checked + span {
  font-weight: 600;
  color: #1e293b;
}

.popup-photos-drop {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  min-height: 64px;
  border-radius: 12px;
  cursor: pointer;
  border: 2px dashed #e5e7eb;
  background: white;
  transition: all 0.2s ease;
}

.popup-photos-drop:hover {
  border-color: var(--popup-primary);
  background: rgba(26, 62, 114, 0.02);
}

.popup-photos-label {
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
  pointer-events: none;
}

.popup-photos-icon {
  width: 28px !important;
  height: 28px !important;
  flex: 0 0 28px;
  color: var(--popup-primary);
}

.photos-title { 
  font-weight: 600; 
  color: #1e293b; 
  font-size: 14px;
  margin-bottom: 2px;
}

.photos-help { 
  font-size: 12px; 
  color: #6b7280; 
  line-height: 1.3;
}

.popup-photos-status { 
  margin-top: 6px; 
  font-size: 12px; 
  color: #6b7280; 
}

.popup-photos-list {
  margin-top: 8px;
  padding: 0;
  list-style: none;
  display: grid;
  gap: 6px;
  max-height: 180px;
  overflow: auto;
}

.hidden { 
  display: none !important; 
}

.checkbox-group.premium { 
  margin: 16px 0; 
}

.checkbox-wrapper { 
  display: flex; 
  align-items: flex-start; 
  gap: 12px; 
}

.checkbox-input { 
  display: none; 
}

.checkbox-label {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  cursor: pointer;
  font-size: 13px;
  line-height: 1.5;
  color: #475569;
}

.checkbox-box {
  width: 18px;
  height: 18px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--premium-transition);
  flex-shrink: 0;
  margin-top: 2px;
}

.checkbox-check {
  width: 12px;
  height: 12px;
  stroke-width: 3;
  color: white;
  opacity: 0;
  transform: scale(0);
  transition: var(--premium-transition);
}

.checkbox-input:checked + .checkbox-label .checkbox-box {
  /* ✅ CHECKBOX avec la couleur popup principale */
  background: var(--popup-primary);
  border-color: var(--popup-primary);
}

.checkbox-input:checked + .checkbox-label .checkbox-check { 
  opacity: 1; 
  transform: scale(1); 
}

.link-primary { 
  /* ✅ LIEN avec la couleur popup principale */
  color: var(--popup-primary); 
  text-decoration: none; 
  font-weight: 500; 
}

.link-primary:hover { 
  text-decoration: underline; 
}

/* ✅ MESSAGE DE SUCCÈS/ERREUR REPOSITIONNÉ */
.form-message.premium {
  padding: 16px 20px;
  border-radius: var(--premium-border-radius);
  margin: 16px 0;
  font-weight: 500;
  text-align: center;
  font-size: 14px;
  line-height: 1.4;
}

.form-message.premium.success {
  background: rgba(236, 253, 245, 0.9);
  color: #047857;
  border: 1px solid rgba(16, 185, 129, 0.3);
}

.form-message.premium.error {
  background: rgba(254, 242, 242, 0.9);
  color: #dc2626;
  border: 1px solid rgba(239, 68, 68, 0.3);
}

.form-actions.premium { 
  display: flex; 
  flex-direction: column; 
  gap: 14px; 
  margin-top: 20px;
  margin-bottom: 18px; 
}

.btn-primary.premium {
  width: 100%;
  background: var(--premium-gradient);
  color: white;
  border: none;
  padding: 14px 20px;
  border-radius: var(--premium-border-radius);
  font-weight: 600;
  font-size: 15.5px;
  cursor: pointer;
  transition: var(--premium-transition);
  min-height: 52px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-primary.premium:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(26, 62, 114, 0.25);
}

.btn-content { 
  display: flex; 
  align-items: center; 
  gap: 8px; 
}

.loading-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top: 2px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  display: none;
}

.btn-primary.premium.loading .loading-spinner { 
  display: block; 
}

.btn-primary.premium.loading #submitText { 
  opacity: 0.7; 
}

@keyframes spin { 
  0% { transform: rotate(0deg); } 
  100% { transform: rotate(360deg); } 
}

.btn-call.premium {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 52px;
  padding: 12px 16px;
  background: white;
  border: 2px solid #1e293b;
  border-radius: var(--premium-border-radius);
  text-decoration: none;
  transition: var(--premium-transition);
}

.btn-call.premium:hover {
  background: #f1f5f9;
  border-color: var(--popup-primary);
  transform: translateY(-2px);
}

.call-content { 
  display: flex; 
  align-items: center; 
  gap: 12px; 
}

.call-icon-wrapper {
  width: 32px;
  height: 32px;
  background: rgba(26, 62, 114, 0.1);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.call-icon { 
  width: 18px; 
  height: 18px; 
  color: var(--popup-primary); 
  stroke-width: 2.5; 
}

.call-text { 
  display: flex; 
  flex-direction: column; 
  text-align: left; 
}

.call-label { 
  font-size: 13px; 
  color: #6b7280; 
  font-weight: 500; 
}

.call-number { 
  font-size: 16px; 
  color: #1e293b; 
  font-weight: 600; 
}

.footer-reassurance.premium { 
  margin-top: 16px; 
}

.reassurance-items {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
}

.reassurance-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11.5px;
  color: #6b7280;
  font-weight: 500;
}

.reassurance-icon { 
  width: 12px; 
  height: 12px; 
  stroke-width: 2.5; 
  color: var(--popup-primary); 
}

/* Mobile responsive */
@media (max-width: 640px) {
  .popup-header {
    padding: 20px 22px 14px;
  }
  
  .popup-title {
    font-size: 20px;
  }
  
  .popup-subtitle {
    font-size: 14px;
    margin-bottom: 8px;
  }

  .popup-body {
    padding: 22px 22px 30px;
  }

  .btn-primary.premium {
    font-size: 16px;
    padding: 14px 20px;
  }

  .reassurance-items { 
    flex-direction: column; 
    gap: 12px; 
  }
  
  .call-content { 
    flex-direction: column; 
    text-align: center; 
    gap: 8px; 
  }
}


/* === RESTAURE LE THÈME BLEU ET RETIRE L'OVERLAY VERT === */
.popup-form {
  /* Bleu Klinova d'origine */
  --popup-primary: #243B53;
  --popup-primary-light: #243B53; /* uniforme pour éviter une dérive de teinte */
}

/* Overlay neutre (noir translucide), plus de teinte verte */
.popup-overlay {
  background: rgba(0, 0, 0, 0.45) !important;
}

/* Petites touches résiduelles qui utilisaient des tints verts en dur */
.form-input.premium {
  box-shadow: 0 2px 8px rgba(36, 59, 83, 0.06) !important; /* 36,59,83 = #243B53 */
}
.btn-primary.premium:hover {
  box-shadow: 0 10px 30px rgba(36, 59, 83, 0.25) !important;
}
.call-icon-wrapper {
  background: rgba(36, 59, 83, 0.10) !important;
}

</style>

<script is:inline>
(() => {
  const overlay = document.getElementById('popupOverlay');
  const form = document.getElementById('popupForm');
  const closeBtn = document.getElementById('closePopup');
  const contactForm = document.getElementById('contactForm');
  const msg = document.getElementById('formMessage');
  const submitBtn = document.getElementById('submitBtn');

  if (!overlay || !form) return;

  // Variables scroll lock
  let prevOverflow = '';
  let prevPaddingRight = '';
  let locked = false;
  
  function lockScroll() {
    if (locked) return;
    locked = true;
    const scrollBarWidth = window.innerWidth - document.documentElement.clientWidth;
    prevOverflow = document.body.style.overflow || '';
    prevPaddingRight = document.body.style.paddingRight || '';
    document.body.style.overflow = 'hidden';
    if (scrollBarWidth > 0) {
      document.body.style.paddingRight = (parseInt(prevPaddingRight) || 0) + scrollBarWidth + 'px';
    }
  }
  
  function unlockScroll() {
    if (!locked) return;
    locked = false;
    document.body.style.overflow = prevOverflow;
    document.body.style.paddingRight = prevPaddingRight;
  }

  // API popup avec contexte
  window.openPopupForm = function (context = {}) {
    // Mise à jour du contexte si fourni
    if (context.title) {
      const titleEl = document.getElementById('popupTitleH2');
      if (titleEl) titleEl.textContent = context.title;
    }
    if (context.subtitle) {
      const subtitleEl = document.querySelector('.popup-subtitle');
      if (subtitleEl) subtitleEl.textContent = context.subtitle;
    }
    if (context.serviceKey) {
      const serviceKeyEl = document.getElementById('popup-service-key');
      if (serviceKeyEl) serviceKeyEl.value = context.serviceKey;
    }
    if (context.serviceLabel) {
      const serviceLabelEl = document.getElementById('popup-service-label');
      if (serviceLabelEl) serviceLabelEl.value = context.serviceLabel;
    }
    if (context.presetSubject) {
      const subjectEl = document.getElementById('popup-subject');
      if (subjectEl) subjectEl.value = context.presetSubject;
    }

    overlay.removeAttribute('hidden');
    overlay.classList.add('active');
    lockScroll();
    setTimeout(() => form.querySelector('input')?.focus(), 100);
  };
  
  window.closePopupForm = function () {
    overlay.classList.remove('active');
    setTimeout(() => {
      overlay.setAttribute('hidden', '');
      unlockScroll();
      contactForm?.reset();
      if (msg) {
        msg.style.display = 'none';
        msg.textContent = '';
        msg.className = 'form-message premium';
      }
      if (window.__resetPhotoUploader) window.__resetPhotoUploader();
    }, 350);
  };

  // Event listeners
  const TRG = '[data-open-popup],[data-openpopup],[data-popup-open]';
  document.addEventListener('click', (e) => {
    const target = e.target.closest(TRG);
    if (target) {
      e.preventDefault();
      
      // Récupération du contexte depuis les data-attributes
      const context = {
        title: target.dataset.popupTitle,
        subtitle: target.dataset.popupSubtitle,
        serviceKey: target.dataset.serviceKey,
        serviceLabel: target.dataset.serviceLabel,
        presetSubject: target.dataset.presetSubject
      };
      
      window.openPopupForm(context);
    }
  });

  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) window.closePopupForm();
  });
  
  closeBtn?.addEventListener('click', () => window.closePopupForm());
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && overlay.classList.contains('active')) {
      window.closePopupForm();
    }
  });

  // Soumission AJAX avec message repositionné
  if (contactForm) {
    contactForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (window.__photosUploadingCount && window.__photosUploadingCount > 0) {
        showMessage('Veuillez attendre la fin de l\'envoi des photos…', 'error');
        return;
      }

      setLoading(true);
      
      try {
        const formData = new FormData(contactForm);
        const response = await fetch('/api/contact', {
          method: 'POST',
          body: formData,
          headers: { 'Accept': 'application/json' }
        });

        let data = null;
        try { data = await response.json(); } catch {}

        if (response.ok) {
          // ✅ MESSAGE DE SUCCÈS VISIBLE EN BAS
          showMessage('✅ Merci ! Votre demande a été envoyée.\nNous vous recontactons rapidement.', 'success');
          contactForm.reset();
          if (window.__resetPhotoUploader) window.__resetPhotoUploader();
          
          // Fermer après 4 secondes
          setTimeout(() => window.closePopupForm(), 4000);
        } else {
          const err = data?.error || data?.message || 'Une erreur est survenue.';
          showMessage(err, 'error');
        }
      } catch (err) {
        showMessage('Impossible de contacter le serveur.', 'error');
      } finally {
        setLoading(false);
      }
    });
  }

  function setLoading(state) {
    if (!submitBtn) return;
    submitBtn.classList.toggle('loading', !!state);
    submitBtn.disabled = !!state;
  }
  
  function showMessage(text, type) {
    if (!msg) return;
    msg.textContent = text || '';
    msg.style.display = text ? 'block' : 'none';
    msg.className = `form-message premium ${type === 'success' ? 'success' : 'error'}`;
    
    // Scroll vers le message pour le rendre visible
    if (text) {
      msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
})();
</script>

{context.showFileUpload && (
  <script is:inline>
  (() => {
    const drop = document.getElementById('popup-photos-drop');
    const input = document.getElementById('popup-photos');
    const list = document.getElementById('popup-photos-list');
    const hidden = document.getElementById('popup-photos-hidden');
    const statusEl = document.getElementById('popup-photos-status');
    
    if (!drop || !input) return;

    const MAX = parseInt(drop.dataset.max || '5', 10);
    const MAX_MB = parseInt(drop.dataset.maxMb || '8', 10);

    window.__photosUploadingCount = 0;
    let files = [];

    window.__resetPhotoUploader = function() {
      files = [];
      window.__photosUploadingCount = 0;
      if (hidden) hidden.innerHTML = '';
      if (statusEl) statusEl.textContent = 'Aucune photo';
      if (list) list.classList.add('hidden');
    };

    // Event listeners simplifiés
    input.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFiles(e.target.files);
        e.target.value = '';
      }
    });

    drop.addEventListener('click', (e) => {
      e.preventDefault();
      input.click();
    });

    function handleFiles(fileList) {
      console.log('Files to upload:', fileList);
      // Logique d'upload simplifiée - à implémenter selon vos besoins
    }
  })();
  </script>
)}