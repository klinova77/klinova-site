---
// src/components/FooterForm2Step.astro
import { PHONE_DISPLAY, PHONE_E164 } from '~/lib/phone';
import { linkAttrs } from '~/lib/links';
import ButtonSubmit from '~/components/UI/ButtonSubmit.astro';

const formId = 'footerLeadForm';              // ‚Üê aligne sur l‚ÄôID d√©j√† pr√©sent
const formName = 'Formulaire bas de page';
const formType = 'devis';

export interface Props {
  title?: string;
  subtitle?: string;
  source?: string;     // tracking
  parisOnly?: boolean; // si true, CP = ^75[0-9]{3}$
}

const {
  title = 'Un technicien vous rappelle sous 4h',
  subtitle = 'Intervention possible d√®s demain ‚Ä¢ Devis gratuit ‚Ä¢ Sans engagement',
  source = 'form-footer',
  parisOnly = false,
} = Astro.props;

const cpPattern = parisOnly ? '^75[0-9]{3}$' : '^[0-9]{5}$';
const cpHelp    = parisOnly ? 'Paris uniquement (75001 √† 75020).' : 'Code postal sur 5 chiffres.';
---


<section id="formulaire" class="section-padding bg-neutral-50">

  <div class="container-responsive max-w-5xl">
    
    <!-- En-t√™te -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center gap-2 bg-success-50 border border-success-200 rounded-full px-4 py-2 mb-4">
        <svg class="w-4 h-4 text-success-600" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span class="text-sm font-medium text-success-700">Techniciens certifi√©s ‚Ä¢ Intervention sous 24h</span>
      </div>

      <h2 class="text-3xl lg:text-4xl font-bold text-primary-600 mb-3">
        {title}
      </h2>

      <p class="text-neutral-600">{subtitle}</p>

      <div class="flex items-center justify-center gap-3 text-neutral-600 mt-3" aria-label="Avis clients">
        <div class="flex items-center gap-1" aria-hidden="true">
         
        </div>
        
      </div>
    </div>

    <!-- Layout principal -->
    <div class="grid lg:grid-cols-3 gap-8 lg:gap-10 items-start">
      
      <!-- FORMULAIRE -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl border border-neutral-200 p-6 lg:p-8 shadow-soft animate-fade-in">

          <!-- Status aria-live -->
          <p data-form-status aria-live="polite" class="text-sm text-neutral-600 mb-3 hidden"></p>

          <!-- Indicateur de progression -->
          <div class="flex items-center justify-between mb-6 pb-4 border-b border-neutral-100">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-primary-600 text-white flex items-center justify-center text-sm font-semibold">1</div>
              <span class="font-medium text-neutral-700">Vos coordonn√©es</span>
            </div>
            <div class="flex items-center gap-3 opacity-50">
              <div class="w-8 h-8 rounded-full border-2 border-neutral-300 text-neutral-400 flex items-center justify-center text-sm">2</div>
              <span class="text-sm text-neutral-500 hidden sm:block">D√©tails (optionnel)</span>
            </div>
          </div>



          <form
  id={formId}
  action="/api/contact"
  method="POST"
  class="space-y-6"
  data-source={source}
  data-intent="lead"
  data-form-name={formName}       
  data-form-type={formType}        
  data-value="290"                
        

>


         
            
            <input type="text" name="website" tabindex="-1" autocomplete="off" class="hidden" aria-hidden="true">

            <!-- √âTAPE 1 -->
            <div data-step="1" class="space-y-5">
            <div class="grid sm:grid-cols-2 gap-4">
  <!-- Champ PR√âNOM (facultatif) -->
  <div class="relative">
    <label for="prenom" class="block text-sm font-semibold text-neutral-700 mb-2">
      Votre pr√©nom <span class="text-neutral-400 font-normal">(facultatif)</span>
    </label>
    <div class="relative">
      <input
        type="text"
        id="prenom"
        name="prenom"
        autocomplete="given-name"
        class="w-full pl-12 pr-10 py-4 rounded-xl border border-neutral-300 focus:border-primary-600 focus:ring-2 focus:ring-primary-200 outline-none transition-all text-base"
        placeholder="Ex. Jean"
      />
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-neutral-400" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
      </svg>
      <div class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 hidden" id="prenom-check">
        <svg class="w-5 h-5 text-success-600" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
      </div>
    </div>
    <small class="text-xs text-red-600 hidden" data-error-for="prenom"></small>
  </div>

  <!-- Champ T√âL√âPHONE (requis) -->
  <div class="relative">
    <label for="telephone" class="block text-sm font-semibold text-neutral-700 mb-2">
      Votre num√©ro de t√©l√©phone <span class="text-red-500">*</span>
    </label>
    <div class="relative">
      <input
        type="tel"
        id="telephone"
        name="telephone"
        required
        inputmode="tel"
        autocomplete="tel"
        class="w-full pl-12 pr-10 py-4 rounded-xl border border-neutral-300 focus:border-primary-600 focus:ring-2 focus:ring-primary-200 outline-none transition-all text-base"
        placeholder="06 12 34 56 78 ou +33 6 12 34 56 78"
      />
      <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-neutral-400" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
      </svg>
      <div class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 hidden" id="telephone-check">
        <svg class="w-5 h-5 text-success-600" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
      </div>
    </div>
    <small class="text-xs text-red-600 hidden" data-error-for="telephone"></small>
  </div>
</div>

              <button
                type="button" id="nextStepBtn"
                class="w-full btn-primary justify-center text-lg py-5 relative overflow-hidden"
                data-action="next-step" aria-controls="footerLeadForm"
              >
                √ätre d√©barrass√© des punaises
              </button>

              <p class="text-center">
                <button type="button" id="openStep2Link" class="text-sm text-primary-600 hover:underline mt-2">
                  + Ajouter des d√©tails √† ma demande
                </button>
              </p>

              <!-- Frise b√©n√©fices -->
              <div class="flex flex-wrap items-center justify-center gap-4 mt-2 pt-4 border-t border-neutral-100">
                <div class="flex items-center gap-2 text-sm text-success-700">
                  <svg class="w-4 h-4" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                  <span class="font-medium">Intervention rapide</span>
                </div>
                <div class="flex items-center gap-2 text-sm text-success-700">
                  <svg class="w-4 h-4" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                  <span class="font-medium">Garantie 6 mois</span>
                </div>
                <div class="flex items-center gap-2 text-sm text-success-700">
                  <svg class="w-4 h-4" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                  <span class="font-medium">Sans engagement</span>
                </div>
              </div>

              <p class="text-center text-xs text-neutral-500 mt-2">üîí Vos informations restent strictement confidentielles</p>
            </div>

            <!-- √âTAPE 2 -->
            <div data-step="2" class="space-y-5 hidden">
              <div class="flex items-center justify-between mb-2 pb-3 border-b border-neutral-100">
                <div class="flex items-center gap-3 opacity-50">
                  <div class="w-8 h-8 rounded-full bg-success-500 text-white flex items-center justify-center text-sm" aria-hidden="true">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                  </div>
                  <span class="text-sm text-neutral-500 line-through">Vos coordonn√©es</span>
                </div>
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-full bg-primary-600 text-white flex items-center justify-center text-sm font-semibold">2</div>
                  <span class="font-medium text-neutral-700">Votre situation</span>
                </div>
              </div>

              <div class="grid sm:grid-cols-2 gap-4">
                <div class="relative">
                  <label for="email" class="block text-sm font-semibold text-neutral-700 mb-2">
                    Votre email <span class="text-neutral-400 font-normal">(facultatif)</span>
                  </label>
                  <div class="relative">
                    <input
                      type="email" id="email" name="email" autocomplete="email"
                      class="w-full pl-12 pr-10 py-3.5 rounded-xl border border-neutral-300 focus:border-primary-600 focus:ring-2 focus:ring-primary-200 outline-none transition-all"
                      placeholder="jean.dupont@email.fr"
                    />
                    <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-neutral-400" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 hidden" id="email-check">
                      <svg class="w-5 h-5 text-success-600" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    </div>
                  </div>
                  <small class="text-xs text-red-600 hidden" data-error-for="email"></small>
                </div>

                <div class="relative">
                  <label for="code_postal" class="block text-sm font-semibold text-neutral-700 mb-2">
                    Code postal du lieu √† traiter
                  </label>
                  <div class="relative">
                    <input
                      type="text" id="code_postal" name="code_postal" inputmode="numeric" pattern={cpPattern}
                      class="w-full pl-12 pr-10 py-3.5 rounded-xl border border-neutral-300 focus:border-primary-600 focus:ring-2 focus:ring-primary-200 outline-none transition-all"
                      placeholder="75011"
                    />
                    <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-neutral-400" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                  </div>
                  <p class="text-xs text-neutral-500 mt-1">{cpHelp}</p>
                  <small class="text-xs text-red-600 hidden" data-error-for="code_postal"></small>
                </div>
              </div>

              <div>
                <label for="message" class="block text-sm font-semibold text-neutral-700 mb-2">
                  D√©crivez bri√®vement votre situation <span class="text-neutral-400">(facultatif)</span>
                </label>
                <textarea
                  id="message" name="message" rows="3"
                  class="w-full px-4 py-3 rounded-xl border border-neutral-300 focus:border-primary-600 focus:ring-2 focus:ring-primary-200 outline-none transition-all resize-none"
                  placeholder="Depuis quand ? Dans quelles pi√®ces ? Intensit√© de l'infestation‚Ä¶"
                ></textarea>
              </div>

              <!-- RGPD -->
              <label class="flex items-start gap-3 text-xs text-neutral-600 leading-relaxed">
                <input type="checkbox" name="rgpd" class="mt-0.5 w-4 h-4 rounded border-neutral-300 text-primary-600 focus:ring-2 focus:ring-primary-200">
                <span>J‚Äôaccepte d‚Äô√™tre recontact√© par Stop-Punaises. <a href="/politique-de-confidentialite" class="text-primary-600 hover:underline" target="_blank" rel="noopener">En savoir plus</a></span>
              </label>

              <div class="grid sm:grid-cols-2 gap-3">
                <button type="button" id="prevStepBtn" class="inline-flex items-center justify-center rounded-lg border border-neutral-300 px-4 py-3 hover:bg-neutral-50 transition-all">
                  ‚Üê Retour
                
                
                
                <ButtonSubmit
    label="Obtenir mon devis"
    formId={formId}                
    formName={formName}
    formType={formType}
    value={290}
    source={source}                
    class="mt-4"
  />





              </div>

              <p class="text-xs text-neutral-500 text-center">üîí Donn√©es prot√©g√©es ‚Äì confidentiel</p>
            </div>
          </form>

          <!-- SUCC√àS -->
          <div id="footerLeadSuccess" class="hidden text-center py-8">
            <div class="w-16 h-16 bg-success-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-success-600" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-primary-600 mb-2">Demande envoy√©e avec succ√®s !</h3>
            <p class="text-neutral-600">Un technicien vous rappelle sous 4h pour √©tablir votre devis personnalis√©.</p>
          </div>
        </div>
      </div>

      <!-- SIDEBAR (sticky pour harmonie visuelle) -->
      <aside class="space-y-6 lg:sticky lg:top-24">
        <!-- Contact direct -->
        <div class="bg-white rounded-2xl border border-neutral-200 p-6 shadow-soft">
          <h3 class="font-bold text-primary-600 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            Besoin d‚Äôune r√©ponse imm√©diate ?
          </h3>

          <a
            href={`tel:${PHONE_E164}`}
            target={linkAttrs(`tel:${PHONE_E164}`).target}
            rel={linkAttrs(`tel:${PHONE_E164}`).rel}
            class="flex items-center gap-3 p-4 rounded-xl border border-neutral-200 hover:border-primary-400 hover:bg-primary-50 transition-all group"
            data-action="call" data-source="form_sidebar"
            aria-label={`Appeler Stop-Punaises au ${PHONE_DISPLAY}`}
          >
            <!-- Ic√¥ne unique -->
            <div class="w-12 h-12 rounded-xl bg-primary-600 flex items-center justify-center group-hover:scale-105 transition-transform shrink-0">
              <svg class="w-6 h-6 text-white" aria-hidden="true" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
              </svg>
            </div>

            <div class="flex-1 min-w-0">
              <!-- Emp√™che le retour √† la ligne du num√©ro -->
              <div class="font-bold text-neutral-900 text-lg leading-none whitespace-nowrap">{PHONE_DISPLAY}</div>
              <div class="text-sm text-primary-700 font-medium mt-1">üìû Appel gratuit ‚Ä¢ Disponible 7j/7</div>
            </div>

            <div class="bg-success-100 text-success-700 text-xs font-bold px-2 py-1 rounded-full shrink-0">DIRECT</div>
          </a>
        </div>

        <!-- Pourquoi nous choisir (compact) -->
        <div class="bg-gradient-to-br from-success-50 to-success-100 rounded-2xl border border-success-200 p-6">
          <h3 class="font-bold text-success-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Pourquoi nos clients nous choisissent
          </h3>
          <ul class="space-y-3 text-sm">
            <li class="flex items-start gap-3">
              <div class="w-5 h-5 rounded-full bg-success-500 flex items-center justify-center flex-shrink-0 mt-0.5" aria-hidden="true">
                <svg class="w-3 h-3 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
              </div>
              <div><strong class="text-success-800">Devis gratuit</strong> en moins de 4h<div class="text-xs text-success-600 mt-1">Sans engagement</div></div>
            </li>
            <li class="flex items-start gap-3">
              <div class="w-5 h-5 rounded-full bg-success-500 flex items-center justify-center flex-shrink-0 mt-0.5" aria-hidden="true">
                <svg class="w-3 h-3 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
              </div>
              <div><strong class="text-success-800">Intervention sous 24h</strong> √† Paris<div class="text-xs text-success-600 mt-1">Urgences possibles</div></div>
            </li>
            <li class="flex items-start gap-3">
              <div class="w-5 h-5 rounded-full bg-success-500 flex items-center justify-center flex-shrink-0 mt-0.5" aria-hidden="true">
                <svg class="w-3 h-3 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
              </div>
              <div><strong class="text-success-800">Garantie 6 mois</strong> (retraitement gratuit)</div>
            </li>
          </ul>
        </div>

        <!-- Certifications + horaires (compact) -->
       
      </aside>
    </div>

    <div class="text-center mt-8">
      <a href="/politique-de-confidentialite" class="text-xs text-neutral-500 hover:text-primary-600 transition-colors" target="_blank" rel="noopener">
        üîí Donn√©es prot√©g√©es ‚Äì Voir notre politique de confidentialit√©
      </a>
    </div>

  </div>
</section>

<style is:global>
@keyframes fadeIn { from { opacity:0; transform:translateY(20px);} to { opacity:1; transform:translateY(0);} }
.animate-fade-in { animation: fadeIn 0.6s ease-out; }
.loading { pointer-events:none; opacity:.9; }
.valid { border-color:#10b981; background-color:#f0fdf4; }
.invalid { border-color:#ef4444; background-color:#fef2f2; }
</style>

<script is:inline>
(() => {
  // Lance init quand le DOM est pr√™t
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  function init() {
    // Pr√©pare dataLayer pour GTM
    window.dataLayer = window.dataLayer || [];

    const form = document.getElementById('footerLeadForm');
    if (!form) return;

    // Scope
    const cardRoot   = form.closest('.bg-white.rounded-2xl') || form.parentElement;
    const statusEl   = cardRoot?.querySelector('[data-form-status]') || null;
    const successBox = cardRoot?.querySelector('#footerLeadSuccess') || null;

    const nextBtn       = form.querySelector('#nextStepBtn');
    const openStep2Link = form.querySelector('#openStep2Link');
    const prevBtn       = form.querySelector('#prevStepBtn');
    const submitBtn     = form.querySelector('button[type="submit"]');

    const step1 = form.querySelector('[data-step="1"]');
    const step2 = form.querySelector('[data-step="2"]');

    const prenom    = form.querySelector('#prenom');
    const telephone = form.querySelector('#telephone');
    const email     = form.querySelector('#email');
    const cp        = form.querySelector('#code_postal');
    const messageEl = form.querySelector('#message');

    // UI helpers
    const show = (el) => el && el.classList.remove('hidden');
    const hide = (el) => el && el.classList.add('hidden');
    const setStatus = (msg, ok = true) => {
      if (!statusEl) return;
      statusEl.textContent = msg || '';
      statusEl.classList.toggle('hidden', !msg);
      statusEl.classList.toggle('text-success-700', ok);
      statusEl.classList.toggle('text-red-600', !ok);
    };
    const setError = (name, msg) => {
      const el = form.querySelector(`[data-error-for="${name}"]`);
      if (el) { el.textContent = msg || ''; el.classList.toggle('hidden', !msg); }
    };
    const spin = (on, label = 'Envoi‚Ä¶') => {
      if (!submitBtn) return;
      if (on) {
        submitBtn.dataset._oldText = submitBtn.textContent || '';
        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-busy','true');
        submitBtn.textContent = label;
      } else {
        submitBtn.disabled = false;
        submitBtn.setAttribute('aria-busy','false');
        if (submitBtn.dataset._oldText) submitBtn.textContent = submitBtn.dataset._oldText;
      }
    };

    // Validation FR
    const normalizePhone = (s='') => { let v = s.replace(/[^\d+]/g,''); if (v.startsWith('00')) v='+'+v.slice(2); return v; };
    const validPhoneFR   = (s) => { const v=normalizePhone(s); return /^0[1-9]\d{8}$/.test(v) || /^\+33[1-9]\d{8}$/.test(v); };
    const validEmail     = (s) => !s || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
    const validCPByAttr  = (input) => {
      if (!input) return true;
      const v = (input.value || '').trim();
      if (!v) return true;
      const pat = input.getAttribute('pattern');
      if (!pat) return /^\d{5}$/.test(v);
      try { return new RegExp(pat).test(v); } catch { return /^\d{5}$/.test(v); }
    };

    // Live phone formatting + check
    telephone?.addEventListener('input', (e) => {
      const input = e.target;
      let v = normalizePhone(input.value || '');
      let formatted = '';
      if (v.startsWith('+33')) {
        let rest = v.slice(3).replace(/\D/g, '');
        if (rest.startsWith('0')) rest = rest.slice(1);
        rest = rest.slice(0, 9);
        const chunks = [];
        if (rest.length > 0) chunks.push(rest.slice(0, 1));
        for (let i = 1; i < rest.length; i += 2) chunks.push(rest.slice(i, i + 2));
        formatted = '+33 ' + chunks.join(' ');
      } else {
        let digits = v.replace(/\D/g, '').slice(0, 10);
        const chunks = [];
        if (digits.length >= 2) {
          chunks.push(digits.slice(0, 2));
          for (let i = 2; i < digits.length; i += 2) chunks.push(digits.slice(i, i + 2));
        } else {
          chunks.push(digits);
        }
        formatted = chunks.join(' ');
      }
      input.value = formatted.trim();
      const ok = validPhoneFR(input.value);
      const check = form.querySelector('#telephone-check');
      input.classList.toggle('valid', ok);
      input.classList.toggle('invalid', !ok && input.value.length>0);
      if (check) check.classList.toggle('hidden', !ok);
      setError('telephone', ok || !input.value ? '' : 'Num√©ro FR invalide.');
    });

    telephone?.addEventListener('blur', (e) => {
      const ok = validPhoneFR(e.target.value);
      setError('telephone', ok || !e.target.value ? '' : 'Num√©ro FR invalide.');
    });

    // Navigation d‚Äô√©tapes
    function gotoStep2(force = false) {
      setError('telephone', '');
      const val = (telephone?.value || '').trim();
      if (!force && !validPhoneFR(val)) {
        setError('telephone', 'Num√©ro FR invalide.');
        telephone?.focus();
        return;
      }
      hide(step1); show(step2); setStatus('');
      setTimeout(() => email?.focus?.(), 40);
    }
    function backToStep1() {
      hide(step2); show(step1); setStatus('');
      setTimeout(() => telephone?.focus(), 40);
    }

    nextBtn?.addEventListener('click', () => gotoStep2(false));
    openStep2Link?.addEventListener('click', () => gotoStep2(true));
    prevBtn?.addEventListener('click', backToStep1);

    // Soumission
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      setStatus('', true);
      ['telephone','email','code_postal'].forEach(n => setError(n,''));

      const okPhone = validPhoneFR(telephone?.value || '');
      const okEmail = validEmail((email?.value || '').trim());
      const okCP    = validCPByAttr(cp);

      if (!okPhone) setError('telephone','Num√©ro FR invalide.');
      if (!okEmail) setError('email','Email invalide.');
      if (!okCP)    setError('code_postal','Code postal invalide.');

      if (!(okPhone && okEmail && okCP)) {
        setStatus('Veuillez corriger les champs indiqu√©s en rouge.', false);
        return;
      }

      spin(true, 'Envoi‚Ä¶');

      try {
        const fd = new FormData(form);
        fd.append('form_context', 'footer_2step');

        const res = await fetch(form.action, { method: 'POST', body: fd });

        if (!res.ok) {
          const msg = (await res.text().catch(() => '')) || 'Erreur lors de l‚Äôenvoi. Merci de v√©rifier vos informations.';
          spin(false);
          setStatus(msg, false);

          // üî¥ Tracking erreur
          document.dispatchEvent(new CustomEvent('formError', {
            detail: { formId: 'footerLeadForm', error: new Error('HTTP not ok') },
          }));
          window.dataLayer.push({
            event: 'lead_error',
            formId: 'footerLeadForm',
            reason: 'http_not_ok'
          });

          return;
        }

        // üü¢ Succ√®s
        document.dispatchEvent(new CustomEvent('formSuccess', { detail: { formId: 'footerLeadForm' } }));

        // ‚öë GTM / Google Ads
        window.dataLayer.push({
          event: 'lead_generated',            // ‚Üê ton d√©clencheur GTM
          formId: 'footerLeadForm',
          source: form.dataset.source || 'form-footer',
          formType: form.dataset.formType || 'devis'
        });

        spin(false);

        // Succ√®s visuel inline
        form.setAttribute('aria-hidden','true');
        form.style.pointerEvents = 'none';
        form.innerHTML = `
          <div class="text-center py-8 animate-fade-in">
            <div class="w-16 h-16 bg-success-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-success-600" aria-hidden="true" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <h3 class="text-xl font-bold text-primary-600 mb-2">Merci !</h3>
            <p class="text-neutral-700 max-w-md mx-auto">
              Nous vous recontactons sous <strong>4&nbsp;h</strong> pour votre devis personnalis√©.<br>
              En attendant, d√©couvrez notre protocole de pr√©paration<br>
              pour maximiser l‚Äôefficacit√© du traitement.
            </p>
            <p class="mt-6 text-sm text-neutral-500">Redirection automatique‚Ä¶</p>
          </div>
        `;

        try { form.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch {}

        try {
          window.gtag?.('event','generate_lead',{
            event_category:'lead',
            event_label: form.dataset.source || 'form-footer',
            value:1
          });
        } catch {}

        setTimeout(() => { window.location.assign('/protocole-punaises-de-lit'); }, 4000);

      } catch (e) {
        console.error('[footerLeadForm] fetch error:', e);
        spin(false);
        setStatus('Erreur r√©seau, merci de r√©essayer ou de nous appeler.', false);

        document.dispatchEvent(new CustomEvent('formError', { detail: { formId: 'footerLeadForm', error: e } }));
        window.dataLayer.push({
          event: 'lead_error',
          formId: 'footerLeadForm',
          reason: 'network_error'
        });
      }
    });
  }
})();
</script>

