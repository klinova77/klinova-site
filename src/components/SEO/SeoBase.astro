---
/**
 * SeoBase.astro ‚Äî SEO centralis√©
 * - GTM/GA seulement apr√®s consentement ‚Üí pas de preconnect par d√©faut
 * - Hreflang rendu uniquement si fourni (site non multilingue sinon)
 */
import { buildSeo } from '~/lib/seo';

export interface Props {
  /* ‚úÖ nouveaux inputs ‚Äúauto‚Äù */
  pathname?: string;            // ex: Astro.url.pathname
  pageType?: string;            // 'home' | 'faq' | 'contact' | ...
  appendBrandToTitle?: boolean; // d√©faut: true

  /* ‚úÖ existants (overrides possibles) */
  title?: string;
  description?: string;
  canonical?: string;            // chemin relatif ou URL absolue
  noindex?: boolean;             // "noindex,follow" si true
  ogImage?: string;              // chemin relatif ou URL absolue
  ogImageAlt?: string;
  articleType?: 'website' | 'article';
  publishedTime?: string;        // ISO 8601
  modifiedTime?: string;         // ISO 8601
  locale?: string;               // ex: "fr_FR"
  jsonLd?: Record<string, any> | Array<Record<string, any>>;
  siteName?: string;             // d√©faut: "Stop-Punaises"
  hrefLangs?: Record<string, string>;  // ex: { fr: '/chemin', en: 'https://...' }
  allowThirdPartyHints?: boolean; // d√©faut: false
}

const {
  /* auto */
  pathname,
  pageType,
  appendBrandToTitle = true,

  /* overrides */
  title = '',
  description = '',
  canonical = '',
  noindex = false,
  ogImage = '/images/og/og-default.jpg',
  ogImageAlt = 'Stop-Punaises ‚Äì Sp√©cialiste punaises de lit √† Paris',
  articleType = 'website',
  publishedTime,
  modifiedTime,
  locale = 'fr_FR',
  jsonLd,
  siteName = 'Stop-Punaises',
  hrefLangs,
  allowThirdPartyHints = false
} = Astro.props as Props;

/* üîß Auto-SEO via helper (respecte tous les overrides fournis) */
const auto = buildSeo({
  pathname: typeof pathname === 'string' ? pathname : (Astro.url?.pathname ?? '/'),
  pageType,
  title,
  description,
  ogImage,
  noindex,
  canonical,
  appendBrandToTitle,
});

/* ‚úÖ valeurs finales */
const finalTitle = auto.title;
const finalDescription = auto.description;
const finalCanonical = auto.canonical;
const finalNoindex = auto.noindex;
const finalOgImage = auto.ogImage;

/* Base site (sans trailing slash) */
const site = Astro.site?.toString().replace(/\/+$/, '') || 'https://stop-punaises.fr';

/* Helper URL absolue */
const toAbs = (url: string) => {
  if (!url) return '';
  return url.startsWith('http') ? url : `${site}${url.startsWith('/') ? url : `/${url}`}`;
};

/* ‚ùó utiliser les *final* */
const canonicalAbs = finalCanonical ? toAbs(finalCanonical) : (Astro.url?.toString() || site);
const ogImageAbs = finalOgImage ? toAbs(finalOgImage) : '';
const robots = finalNoindex ? 'noindex, follow' : 'index, follow';
---

<!-- Title & Description -->
<title>{finalTitle}</title>
{finalDescription && <meta name="description" content={finalDescription} />}

<!-- Robots -->
<meta name="robots" content={robots} />
<meta name="googlebot" content={robots} />

<!-- Canonical -->
{canonicalAbs && <link rel="canonical" href={canonicalAbs} />}

<!-- Hreflang (UNIQUEMENT si variants fournis) -->
{hrefLangs &&
  Object.entries(hrefLangs).map(([lang, url]) => (
    <link rel="alternate" hreflang={lang} href={url.startsWith('http') ? url : toAbs(url)} />
  ))
}

<!-- Open Graph -->
<meta property="og:type" content={articleType} />
<meta property="og:site_name" content={siteName} />
<meta property="og:title" content={finalTitle} />
{finalDescription && <meta property="og:description" content={finalDescription} />}
{canonicalAbs && <meta property="og:url" content={canonicalAbs} />}
{locale && <meta property="og:locale" content={locale} />}
{ogImageAbs && (
  <>
    <meta property="og:image" content={ogImageAbs} />
    <meta property="og:image:alt" content={ogImageAlt} />
    {/* Pas de type/width/height pour laisser les crawlers g√©rer (ou assure une 1200x630) */}
  </>
)}

<!-- Article (si article) -->
{articleType === 'article' && (
  <>
    {publishedTime && <meta property="article:published_time" content={publishedTime} />}
    {modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
    <meta property="article:author" content={siteName} />
    <meta property="article:section" content="D√©sinsectisation" />
    <meta property="article:tag" content="punaises de lit" />
    <meta property="article:tag" content="d√©sinsectisation" />
    <meta property="article:tag" content="Paris" />
  </>
)}

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={finalTitle} />
{finalDescription && <meta name="twitter:description" content={finalDescription} />}
{ogImageAbs && (
  <>
    <meta name="twitter:image" content={ogImageAbs} />
    <meta name="twitter:image:alt" content={ogImageAlt} />
  </>
)}

<!-- JSON-LD (fallback LocalBusiness si rien n‚Äôest fourni) -->
{!jsonLd && (
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    "name": siteName,
    "description": finalDescription || "Traitement professionnel des punaises de lit √† Paris et en √éle-de-France. Devis gratuit, intervention rapide, garantie incluse. Certification Certibiocide.",
    "url": site,
    "logo": `${site}/images/logo-stop-punaises.webp`,
    "image": ogImageAbs || `${site}/images/og/og-default.jpg`,
    "telephone": "+33630221228",
    "address": {
      "@type": "PostalAddress",
      "streetAddress": "6 rue d'Armaill√©",
      "addressLocality": "Paris",
      "postalCode": "75017",
      "addressCountry": "FR"
    },
    "areaServed": "√éle-de-France",
    "priceRange": "‚Ç¨‚Ç¨",
    "openingHours": "Mo-Su 08:00-20:00"
  })} />
)}

{jsonLd && (
  Array.isArray(jsonLd)
    ? jsonLd.map((obj) => (
        <script type="application/ld+json" set:html={JSON.stringify(obj)}></script>
      ))
    : <script type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>
)}

<!-- Hints tiers optionnels (apr√®s consentement explicite) -->
{allowThirdPartyHints && (
  <>
    <link rel="preconnect" href="https://www.google-analytics.com" crossorigin />
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
    <link rel="dns-prefetch" href="//www.google-analytics.com" />
    <link rel="dns-prefetch" href="//www.googletagmanager.com" />
  </>
)}
