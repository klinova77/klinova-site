---
/**
 * SeoBase.astro — Klinova
 * SEO centralisé pour le site Klinova :
 * - balises meta (title, desc, OG, Twitter)
 * - JSON-LD Organization (KLINOVA) + LocalBusiness (siège Chelles + zones IDF)
 * - relation hasBrand avec Stop-Punaises
 */

import { buildSeo } from '~/lib/seo'

export interface Props {
  pathname?: string
  pageType?: string
  appendBrandToTitle?: boolean
  title?: string
  description?: string
  canonical?: string
  noindex?: boolean
  ogImage?: string
  ogImageAlt?: string
  articleType?: 'website' | 'article'
  publishedTime?: string
  modifiedTime?: string
  locale?: string
  jsonLd?: Record<string, any> | Array<Record<string, any>>
  siteName?: string
  hrefLangs?: Record<string, string>
  allowThirdPartyHints?: boolean
}

const {
  pathname,
  pageType,
  appendBrandToTitle = true,
  title = '',
  description = '',
  canonical = '',
  noindex = false,
  ogImage = '/images/og/og-default.jpg',
  ogImageAlt = 'Klinova – Propreté & maintenance en Île-de-France',
  articleType = 'website',
  publishedTime,
  modifiedTime,
  locale = 'fr_FR',
  jsonLd,
  siteName = 'Klinova',
  hrefLangs,
  allowThirdPartyHints = false,
} = Astro.props as Props

// Domaine & helper URL
const site = (Astro.site?.toString().replace(/\/+$/, '') || 'https://klinova.fr') as string

const toAbs = (url?: string) =>
  !url
    ? site
    : url.startsWith('http')
      ? url
      : `${site}${url.startsWith('/') ? url : `/${url}`}`

// Path effectif pour SEO
const effectivePath =
  typeof pathname === 'string'
    ? pathname
    : Astro.url?.pathname || '/'

// Auto SEO
const auto = buildSeo({
  pathname: effectivePath,
  pageType,
  title,
  description,
  ogImage,
  noindex,
  canonical,
  appendBrandToTitle,
})

const finalTitle       = auto.title
const finalDescription = auto.description
const finalCanonical   = auto.canonical
const finalNoindex     = auto.noindex
const finalOgImage     = auto.ogImage

// Canonical & meta
const canonicalAbs =
  finalCanonical
    ? toAbs(finalCanonical)
    : canonical
      ? toAbs(canonical)
      : `${site}${effectivePath}`

const ogImageAbs = finalOgImage ? toAbs(finalOgImage) : ''
const robots     = finalNoindex ? 'noindex, follow' : 'index, follow'

// IDs JSON-LD
const orgId = `${site}#organization`
const lbId  = `${site}#localbusiness`

// Organization JSON-LD (KLINOVA)
const orgJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  '@id': orgId,
  name: 'Klinova',
  legalName: 'KLINOVA',
  url: site,
  logo: `${site}/images/logo-klinova.webp`,
  description:
    'Entreprise de propreté et de maintenance technique en Île-de-France : parkings, moquettes, balcons, hygiène renforcée.',
  hasBrand: {
    '@type': 'Brand',
    name: 'Stop-Punaises',
    url: 'https://stop-punaises.fr',
  },
}

// LocalBusiness JSON-LD (siège Chelles + zones IDF)
const localBusinessJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'LocalBusiness',
  '@id': lbId,
  name: 'Klinova',
  legalName: 'KLINOVA',
  url: site,
  image: ogImageAbs || `${site}/images/og/og-default.jpg`,
  telephone: '+33676738661',
  priceRange: '€€',
  address: {
    '@type': 'PostalAddress',
    streetAddress: '9 allée de la Prairie',
    postalCode: '77500',
    addressLocality: 'Chelles',
    addressRegion: 'Île-de-France',
    addressCountry: 'FR',
  },
  serviceArea: [
    { '@type': 'AdministrativeArea', name: 'Île-de-France' },
    { '@type': 'AdministrativeArea', name: 'Paris' },
    { '@type': 'AdministrativeArea', name: 'Seine-et-Marne' },
    { '@type': 'AdministrativeArea', name: 'Hauts-de-Seine' },
    { '@type': 'AdministrativeArea', name: 'Seine-Saint-Denis' },
    { '@type': 'AdministrativeArea', name: 'Val-de-Marne' },
  ],
  areaServed: [
    { '@type': 'AdministrativeArea', name: 'Île-de-France' },
    { '@type': 'City', name: 'Paris' },
    { '@type': 'City', name: 'Chelles' },
  ],
  openingHours: 'Mo-Su 08:00-20:00',
  parentOrganization: { '@id': orgId },
  description:
    finalDescription ||
    'Nettoyage professionnel (parkings, moquettes, balcons) et hygiène renforcée en Île-de-France. Protocoles documentés, traçabilité.',
}

// JSON-LD additionnels
const extraJsonLd = Array.isArray(jsonLd) ? jsonLd : jsonLd ? [jsonLd] : []


 const websiteJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  '@id': `${site}#website`,
  url: site,
  name: siteName,
  publisher: { '@id': orgId },
  inLanguage: 'fr-FR'
}

const jsonLdBlocks = [
  websiteJsonLd,
  orgJsonLd,
  localBusinessJsonLd,
  ...extraJsonLd,
]

---

<title>{finalTitle}</title>
{finalDescription && <meta name="description" content={finalDescription} />}

<meta name="robots" content={robots} />
<meta name="googlebot" content={robots} />

{canonicalAbs && <link rel="canonical" href={canonicalAbs} />}

{hrefLangs &&
  Object.entries(hrefLangs).map(([lang, url]) => (
    <link
      rel="alternate"
      hreflang={lang}
      href={toAbs(url)}
    />
  ))}

<meta property="og:type" content={articleType} />
<meta property="og:site_name" content={siteName} />
<meta property="og:title" content={finalTitle} />
{finalDescription && <meta property="og:description" content={finalDescription} />}
{canonicalAbs && <meta property="og:url" content={canonicalAbs} />}
{locale && <meta property="og:locale" content={locale} />}
{ogImageAbs && (
  <>
    <meta property="og:image" content={ogImageAbs} />
    <meta property="og:image:alt" content={ogImageAlt} />
  </>
)}

{articleType === 'article' && (
  <>
    {publishedTime && (
      <meta property="article:published_time" content={publishedTime} />
    )}
    {modifiedTime && (
      <meta property="article:modified_time" content={modifiedTime} />
    )}
    <meta property="article:author" content={siteName} />
    <meta
      property="article:section"
      content="Propreté et hygiène professionnelle"
    />
    <meta property="article:tag" content="nettoyage professionnel" />
    <meta property="article:tag" content="Île-de-France" />
  </>
)}

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={finalTitle} />
{finalDescription && (
  <meta name="twitter:description" content={finalDescription} />
)}
{ogImageAbs && (
  <>
    <meta name="twitter:image" content={ogImageAbs} />
    <meta name="twitter:image:alt" content={ogImageAlt} />
  </>
)}

{jsonLdBlocks.map((obj) => (
  <script
    type="application/ld+json"
    set:html={JSON.stringify(obj)}
  ></script>
))}

{allowThirdPartyHints && (
  <>
    <link
      rel="preconnect"
      href="https://www.google-analytics.com"
      crossorigin
    />
    <link
      rel="preconnect"
      href="https://www.googletagmanager.com"
      crossorigin
    />
    <link rel="dns-prefetch" href="//www.google-analytics.com" />
    <link rel="dns-prefetch" href="//www.googletagmanager.com" />
  </>
)}
