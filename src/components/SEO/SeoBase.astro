---
/**
 * SeoBase.astro — KLINOVA (adresse masquée, SAB, marque Stop-Punaises reliée)
 * - Centralise Title/OG/Twitter + JSON-LD.
 * - Injecte Organization (KLINOVA) + LocalBusiness (SAB).
 * - Les pages peuvent ajouter des JSON-LD (ex: Service) via `jsonLd`.
 */

import { buildSeo } from '~/lib/seo'

export interface Props {
  pathname?: string
  pageType?: string
  appendBrandToTitle?: boolean

  title?: string
  description?: string
  canonical?: string
  noindex?: boolean
  ogImage?: string
  ogImageAlt?: string
  articleType?: 'website' | 'article'
  publishedTime?: string
  modifiedTime?: string
  locale?: string
  jsonLd?: Record<string, any> | Array<Record<string, any>>
  siteName?: string
  hrefLangs?: Record<string, string>
  allowThirdPartyHints?: boolean
}

const {
  pathname,
  pageType,
  appendBrandToTitle = true,

  title = '',
  description = '',
  canonical = '',
  noindex = false,
  ogImage = '/images/og/og-default.jpg',
  ogImageAlt = 'Klinova – Propreté & maintenance en Île-de-France',
  articleType = 'website',
  publishedTime,
  modifiedTime,
  locale = 'fr_FR',
  jsonLd,
  siteName = 'Klinova',
  hrefLangs,
  allowThirdPartyHints = false,
} = Astro.props as Props

/* Auto SEO */
const auto = buildSeo({
  pathname: typeof pathname === 'string' ? pathname : (Astro.url?.pathname ?? '/'),
  pageType,
  title,
  description,
  ogImage,
  noindex,
  canonical,
  appendBrandToTitle,
})

const finalTitle       = auto.title
const finalDescription = auto.description
const finalCanonical   = auto.canonical
const finalNoindex     = auto.noindex
const finalOgImage     = auto.ogImage

/* Domaine principal */
const site = Astro.site?.toString().replace(/\/+$/, '') || 'https://klinova.fr'

/* Helper URL absolue */
const toAbs = (url: string) =>
  !url ? '' : (url.startsWith('http') ? url : `${site}${url.startsWith('/') ? url : `/${url}`}`)

/* Données finales */
const canonicalAbs = finalCanonical ? toAbs(finalCanonical) : (Astro.url?.toString() || site)
const ogImageAbs   = finalOgImage ? toAbs(finalOgImage) : ''
const robots       = finalNoindex ? 'noindex, follow' : 'index, follow'

/* IDs JSON-LD */
const orgId = `${site}#organization`
const lbId  = `${site}#localbusiness`

/* Organization — KLINOVA (entité légale principale) */
const orgJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  '@id': orgId,
  name: siteName,                       // KLINOVA
  legalName: 'KLINOVA',
  url: site,
  logo: `${site}/images/logo-klinova.webp`,
  brand: siteName,
  description:
    'Entreprise de propreté et de maintenance technique en Île-de-France : parkings, moquettes, balcons, hygiène renforcée.',
  /* Optionnel: sameAs */
  // sameAs: ['https://www.linkedin.com/company/klinova'],
  /* Relation vers la marque Stop-Punaises (activité spécialisée) */
  hasBrand: {
    '@type': 'Brand',
    name: 'Stop-Punaises',
    url: 'https://stop-punaises.fr',
  },
}

/* LocalBusiness — KLINOVA en mode SAB (adresse masquée) */
const localBusinessJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'LocalBusiness',
  '@id': lbId,
  name: siteName,
  legalName: 'KLINOVA',
  url: site,
  image: ogImageAbs || `${site}/images/og/og-default.jpg`,
  telephone: '+33676738661',
  priceRange: '€€',
  /* Adresse masquée : pas de streetAddress ; on expose seulement la localité/région/pays */
  address: {
    '@type': 'PostalAddress',
    addressLocality: 'Chelles',
    addressRegion: 'Île-de-France',
    addressCountry: 'FR',
  },
  /* Zones desservies */
  serviceArea: [
    { '@type': 'AdministrativeArea', name: 'Paris' },
    { '@type': 'AdministrativeArea', name: 'Seine-et-Marne' },
    { '@type': 'AdministrativeArea', name: 'Hauts-de-Seine' },
    { '@type': 'AdministrativeArea', name: 'Seine-Saint-Denis' },
    { '@type': 'AdministrativeArea', name: 'Val-de-Marne' },
    { '@type': 'AdministrativeArea', name: 'Île-de-France' },
  ],
  areaServed: [
    { '@type': 'AdministrativeArea', name: 'Île-de-France' },
    { '@type': 'City', name: 'Paris' },
    { '@type': 'City', name: 'Chelles' },
  ],
  openingHours: 'Mo-Su 08:00-20:00',
  parentOrganization: { '@id': orgId },
  description:
    finalDescription ||
    'Nettoyage professionnel (parkings, moquettes, balcons) et hygiène renforcée en Île-de-France. Protocoles documentés, traçabilité.',
}
---

<!-- ===== Title & Description ===== -->
<title>{finalTitle}</title>
{finalDescription && <meta name="description" content={finalDescription} />}

<!-- Robots -->
<meta name="robots" content={robots} />
<meta name="googlebot" content={robots} />

<!-- Canonical -->
{canonicalAbs && <link rel="canonical" href={canonicalAbs} />}

<!-- Hreflang -->
{hrefLangs &&
  Object.entries(hrefLangs).map(([lang, url]) => (
    <link rel="alternate" hreflang={lang} href={url.startsWith('http') ? url : toAbs(url)} />
  ))}

<!-- Open Graph -->
<meta property="og:type" content={articleType} />
<meta property="og:site_name" content={siteName} />
<meta property="og:title" content={finalTitle} />
{finalDescription && <meta property="og:description" content={finalDescription} />}
{canonicalAbs && <meta property="og:url" content={canonicalAbs} />}
{locale && <meta property="og:locale" content={locale} />}
{ogImageAbs && (
  <>
    <meta property="og:image" content={ogImageAbs} />
    <meta property="og:image:alt" content={ogImageAlt} />
  </>
)}

<!-- Article -->
{articleType === 'article' && (
  <>
    {publishedTime && <meta property="article:published_time" content={publishedTime} />}
    {modifiedTime &&  <meta property="article:modified_time"  content={modifiedTime}  />}
    <meta property="article:author"  content={siteName} />
    <meta property="article:section" content="Propreté et hygiène professionnelle" />
    <meta property="article:tag"     content="nettoyage professionnel" />
    <meta property="article:tag"     content="Île-de-France" />
    <meta property="article:tag"     content="Paris" />
  </>
)}

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content={finalTitle} />
{finalDescription && <meta name="twitter:description" content={finalDescription} />}
{ogImageAbs && (
  <>
    <meta name="twitter:image" content={ogImageAbs} />
    <meta name="twitter:image:alt" content={ogImageAlt} />
  </>
)}

<!-- JSON-LD globaux -->
<script type="application/ld+json" set:html={JSON.stringify(orgJsonLd)} />
<script type="application/ld+json" set:html={JSON.stringify(localBusinessJsonLd)} />

<!-- JSON-LD additionnels (ex: Service) -->
{jsonLd && (
  Array.isArray(jsonLd)
    ? jsonLd.map((obj) => (
        <script type="application/ld+json" set:html={JSON.stringify(obj)}></script>
      ))
    : <script type="application/ld+json" set:html={JSON.stringify(jsonLd)}></script>
)}

<!-- Hints tiers (après consentement) -->
{allowThirdPartyHints && (
  <>
    <link rel="preconnect" href="https://www.google-analytics.com" crossorigin />
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
    <link rel="dns-prefetch" href="//www.google-analytics.com" />
    <link rel="dns-prefetch" href="//www.googletagmanager.com" />
  </>
)}
